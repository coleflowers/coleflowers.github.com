---
layout: default
title: 在windows下用mingw编译zbar
description: 在windows下用mingw编译zbar
keywords: windows;mingw;zbar;libiconv;
sort: other
---
<h1>在windows下用mingw编译zbar</h1>
<p>在iOS项目中实现过几次二维码扫描功能，都是用的zbar，从哪儿下载的都忘了，还是别人编译好的静态库。刚好手上有个android的东西缺个二维码扫描的功能。从github找到项目地址：https://github.com/ZBar/ZBar，下载针对android的release版本(<a href="https://github.com/ZBar/ZBar/archive/AndroidSDK-0.1.zip">https://github.com/ZBar/ZBar/archive/AndroidSDK-0.1.zip</a>)。</p>
<p>以下操作在windows操作系统下完成，依赖以下条件：</p>

<ol>
<li>需要系统安装MinGW(需要msys，当然依照博文2的操作安装cygwin也可以)</li>
<li>需要ndk(Native Development Kit)，<a href="http://dl.google.com/android/repository/android-ndk-r12-windows-x86_64.zip">32位下载地址</a></li>
<li>需要ant</li>
<li>需要android sdk (Android Software Development Kit)</li>
<li>java sdk</li>
</ol>

<p>找了一篇别人的操作后记录的博文1:<a href="http://twinsant.com/tech/build-zbar">Clone and build ZBar on Ubuntu and Mac OS X</a>，没弄成功，继续找资料看到博文2:<a href="http://www.cnblogs.com/rainboy2010/p/4674389.html">zbar android sdk源码编译</a>。</p>
<p>参考博文1下载了<a href="https://github.com/twinsant/libiconv">libiconv</a>。</p>
<p>a.修改libcharset/config.h文件,将#define HAVE_LANGINFO_CODESET 1 改为#define HAVE_LANGINFO_CODESET 0</p>
<p>b.修改文件libcharset/lib/localcharset.c文件中函数get_charset_aliases (void),搜索:int c;把该变量定义放到该函数的开始处。</p>
<p>c.\libcharset\lib\localcharset.c文件末尾增加了这个

<pre>
<code>
size_t __ctype_get_mb_cur_max(void){
  return 1;
}
</code>
</pre>
这一步的修改是由于整个过程第一次完成后发现，生成的so文件和zbar.jar放到测试项目里，编译完的测试项目在安卓4.2.2中闪退，报如下错误:
<pre>
	<code>
E/AndroidRuntime(17107): Caused by: java.lang.UnsatisfiedLinkError: Cannot load library: soinfo_relocate(linker.cpp:976): cannot locate symbol "__ctype_get_mb_cur_max" referenced by "libiconv.so"...

E/AndroidRuntime(17107): 	at java.lang.Runtime.loadLibrary(Runtime.java:382)

E/AndroidRuntime(17107): 	at java.lang.System.loadLibrary(System.java:535)

E/AndroidRuntime(17107): 	at net.sourceforge.zbar.android.CameraTest.CameraTestActivity.&#60;clinit>(CameraTestActivity.java:54)

E/AndroidRuntime(17107): 	... 15 more		
	</code>
</pre>


<pre>
	<code>
E/dalvikvm(16799): dlopen("/data/app-lib/net.sourceforge.zbar.android.CameraTest-1/libiconv.so") failed: Cannot load library: soinfo_relocate

(linker.cpp:976): cannot locate symbol "__ctype_get_mb_cur_max" referenced by "libiconv.so"...		
	</code>
</pre>
</p>

<p>(c.)的修改具体见博文3：<a href="https://magiclen.org/zbar/">如何在Android系統上使用zBar來實現條碼掃描？</a>。修改完的libiconv代码我在github传了一份，可以直接下载不用自己修改了:<a href="https://github.com/coleflowers/libiconv">https://github.com/coleflowers/libiconv</a></p>

<p>准备好libiconv代码之后，在MinGW Shell中进入libiconv源码目录执行configure生成Makefile文件:</p>
<p>
<pre>
	<code>
./configure --build=x86_64-pc-linux-gnu --host=arm-linux-eabi	
	</code>
</pre>
</p>
<p>运行结束之后会在libiconv目录下生成Makefile文件。然后在zbar源码目录ZBar-AndroidSDK-0.1\android\local.properties文件中指定变量iconv.src的值为你电脑中libiconv的路径：</p>
<p>
<pre>
	<code>
iconv.src=盘符:/libiconv路径 		
	</code>
</pre>
</p>
<p>然后继续在ZBar-AndroidSDK-0.1\android\local.properties中配置sdk.dir和ndk.dir。local.properties，配置完之后参考zbar源码中\ZBar-AndroidSDK-0.1\android\README文件，分别执行</p>
<ul>
	<li>android update project --path .</li>
	<li>ant -Dndk.dir=&#60;NDK path> -Diconv.src=&#60;iconv library src> zbar-all</li>
</ul>
<p>执行成功的话结果如下图:</p>
<p><img src="/images/20160624/001.jpg" width="500px" alt=""></p>